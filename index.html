<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Money Rider - Premium</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --primary: #FF5722; 
            --primary-grad: linear-gradient(135deg, #FF5722, #FF8A65);
            --dark: #121212;
            --surface: #ffffff;
            --bg: #F2F4F8;
            --success: #00C853;
            --shadow-soft: 0 10px 40px rgba(255, 87, 34, 0.15);
            --shadow-hard: 0 10px 30px rgba(255, 87, 34, 0.4);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #333; height: 100vh; overflow: hidden; position: relative; }
        .hidden { display: none !important; }

        /* --- SPLASH SCREEN --- */
        #splash-screen {
            position: fixed; inset: 0; background: var(--primary); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; transition: opacity 0.5s ease;
        }
        .splash-icon { 
            font-size: 60px; color: var(--primary); background: white; 
            width: 120px; height: 120px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 50px rgba(0,0,0,0.2);
            animation: drive 1.5s infinite ease-in-out;
        }
        @keyframes drive { 
            0% { transform: translateX(-10px) rotate(-5deg); }
            50% { transform: translateX(10px) rotate(5deg); }
            100% { transform: translateX(-10px) rotate(-5deg); }
        }
        .splash-text { margin-top: 25px; font-size: 2rem; font-weight: 800; letter-spacing: 1px; }

        /* --- BUTTONS (ORANGE THEME) --- */
        .btn-orange-round {
            width: 45px; height: 45px; border-radius: 12px;
            background: var(--primary); color: white;
            display: flex; align-items: center; justify-content: center;
            box-shadow: var(--shadow-hard); cursor: pointer;
            border: 2px solid white; transition: 0.2s;
        }
        .btn-orange-round:active { transform: scale(0.9); }
        
        .top-left-btn { position: absolute; top: 20px; left: 20px; z-index: 1000; }
        .top-right-group { position: absolute; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 15px; }

        /* --- AUTH SCREEN --- */
        .auth-screen { position: fixed; inset: 0; background: white; z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px; }
        .form-control { width: 100%; padding: 18px; border-radius: 15px; border: 1px solid #eee; margin-bottom: 20px; font-size: 1.1rem; text-align: center; background: #f8f9fa; font-weight: 600; outline: none; }
        .form-control:focus { border-color: var(--primary); background: white; }
        .btn-main { padding: 16px; width: 100%; border: none; border-radius: 15px; font-weight: 700; font-size: 1.1rem; cursor: pointer; background: var(--primary); color: white; box-shadow: var(--shadow-hard); }

        /* --- SIDEBAR --- */
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2100; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(3px); }
        .sidebar { position: fixed; top: 0; left: 0; height: 100%; width: 280px; background: white; z-index: 2200; transform: translateX(-100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); padding: 25px; display: flex; flex-direction: column; border-radius: 0 20px 20px 0; }
        .sidebar.open { transform: translateX(0); }
        .sidebar-overlay.open { opacity: 1; pointer-events: auto; }
        
        /* --- SCANNING RADAR --- */
        #scanning-screen { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #1a1a1a; color: white; }
        .radar-box { position: relative; width: 250px; height: 250px; display: flex; align-items: center; justify-content: center; margin-bottom: 40px; }
        .pulse-ring { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 2px solid var(--primary); opacity: 0; animation: ripple 2s infinite; }
        .pulse-ring:nth-child(2) { animation-delay: 0.5s; }
        .pulse-ring:nth-child(3) { animation-delay: 1s; }
        .center-logo { width: 70px; height: 70px; background: white; border-radius: 50%; padding: 10px; z-index: 5; box-shadow: 0 0 30px var(--primary); }
        @keyframes ripple { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }

        /* --- DELIVERY SCREEN --- */
        #map-view { width: 100%; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        
        /* BOTTOM SHEET (The Magic Part) */
        .bottom-sheet {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: white; border-radius: 30px 30px 0 0;
            box-shadow: 0 -10px 50px rgba(0,0,0,0.2); z-index: 1100;
            /* Initially only show header (approx 80px) */
            transform: translateY(calc(100% - 85px)); 
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column; max-height: 85vh;
        }
        .bottom-sheet.open { transform: translateY(0); }
        
        .sheet-drag-area { width: 100%; padding: 15px 0 10px; display: flex; flex-direction: column; align-items: center; cursor: grab; background: white; border-radius: 30px 30px 0 0; }
        .sheet-handle { width: 60px; height: 6px; background: #e0e0e0; border-radius: 10px; margin-bottom: 10px; position: relative; overflow: hidden; }
        /* Animated Handle */
        .sheet-handle::after { content:''; position: absolute; top:0; left:0; width:100%; height:100%; background: var(--primary); transform: translateX(-100%); animation: loadLine 2s infinite; }
        @keyframes loadLine { 100% { transform: translateX(100%); } }

        .sheet-minimized-info { font-size: 1.2rem; font-weight: 800; color: #333; letter-spacing: 1px; display: flex; align-items: center; gap: 10px; }
        
        .sheet-content { padding: 10px 25px 30px; overflow-y: auto; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .bottom-sheet.open .sheet-content { opacity: 1; pointer-events: auto; }

        /* Premium Location Card */
        .loc-card { background: #FFF3E0; border: 1px solid #FFCCBC; padding: 15px; border-radius: 15px; margin-bottom: 20px; display: flex; gap: 15px; align-items: center; position: relative; overflow: hidden; }
        .loc-card::before { content:''; position: absolute; width: 5px; height: 100%; background: var(--primary); left: 0; top: 0; }
        .loc-icon { font-size: 1.5rem; color: var(--primary); }

        /* Premium Call Button */
        .btn-call-premium {
            background: var(--primary-grad); color: white;
            padding: 15px; border-radius: 15px; border: none;
            width: 100%; font-weight: 700; font-size: 1.1rem;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: var(--shadow-hard); cursor: pointer; margin-top: 10px;
        }
        
        /* Slider with Orange Shadow */
        .slider-wrapper { margin-top: 20px; position: relative; height: 65px; background: #fff; border: 2px solid #eee; border-radius: 35px; overflow: hidden; display: flex; align-items: center; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); }
        .slider-thumb { width: 55px; height: 55px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; position: absolute; left: 3px; z-index: 2; box-shadow: 10px 0 20px rgba(255, 87, 34, 0.6); cursor: grab; }
        .slider-text { width: 100%; text-align: center; font-weight: 700; color: #aaa; z-index: 1; font-size: 0.9rem; letter-spacing: 2px; }

        /* Image Popup */
        .img-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        .img-modal.active { opacity: 1; pointer-events: auto; }
        .img-modal img { max-width: 90%; max-height: 80%; border-radius: 20px; border: 4px solid var(--primary); box-shadow: 0 0 50px rgba(255, 87, 34, 0.5); transform: scale(0.8); transition: 0.3s; }
        .img-modal.active img { transform: scale(1); }

        /* Loader */
        .loader-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 9000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .spinner { width: 60px; height: 60px; border: 6px solid #eee; border-top: 6px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* INCOMING */
        .incoming-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 4000; display: flex; flex-direction: column; justify-content: flex-end; padding: 20px; }
        .incoming-card { background: white; border-radius: 25px; padding: 30px 20px; text-align: center; animation: slideUp 0.3s; }
        @keyframes slideUp { from {transform: translateY(100%)} to {transform: translateY(0)}}

        /* Items */
        .item-row { display: flex; align-items: center; gap: 15px; padding: 10px; border: 1px solid #FFCCBC; background: #fffbfb; border-radius: 12px; margin-bottom: 8px; }
    </style>
</head>
<body>

    <div id="toast-container"></div>
    <div id="loader" class="loader-overlay hidden"><div class="spinner"></div></div>

    <!-- IMAGE POPUP -->
    <div id="img-popup" class="img-modal" onclick="closeImgPopup()">
        <img id="popup-img-src" src="">
    </div>

    <!-- SPLASH SCREEN -->
    <div id="splash-screen">
        <div class="splash-icon"><i class="fas fa-motorcycle"></i></div>
        <div class="splash-text">Money Rider</div>
    </div>

    <!-- LOGIN -->
    <div id="login-screen" class="auth-screen hidden">
        <img src="https://cdn-icons-png.flaticon.com/512/7541/7541900.png" style="width:80px; margin-bottom:20px">
        <h2 style="margin-bottom:10px">Rider Login</h2>
        <p style="color:#777; margin-bottom:30px">Deliver & Earn Money</p>
        <input type="text" id="license-input" class="form-control" placeholder="ENTER LICENSE">
        <div style="display:flex; gap:10px; margin-bottom:20px; align-self:flex-start; margin-left:10px">
            <input type="checkbox" id="remember-me"> <label for="remember-me">Remember License</label>
        </div>
        <button class="btn-main" onclick="verifyLicense()">START DRIVING</button>
    </div>

    <!-- SIDEBAR -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar">
        <div style="margin-bottom:30px; display:flex; align-items:center; gap:15px">
            <div style="width:60px; height:60px; background:#f0f0f0; border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--primary); font-size:1.5rem"><i class="fas fa-user-astronaut"></i></div>
            <div>
                <h3 id="side-name">Rider</h3>
                <span style="color:var(--success); font-weight:600">● Active</span>
            </div>
        </div>
        <div style="font-weight:700; color:#aaa; margin-bottom:15px; font-size:0.8rem">HELD ORDERS</div>
        <div id="hold-list-container" style="flex:1; overflow-y:auto; padding-right:5px"></div>
        <button class="btn-main" style="background:#333; margin-top:20px" onclick="logout()">LOGOUT</button>
    </div>

    <!-- MAIN APP CONTENT -->
    <div id="app-content" class="hidden">
        <!-- TOP BUTTONS (ORANGE) -->
        <div class="btn-orange-round top-left-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
        <div class="top-right-group">
            <div class="btn-orange-round" onclick="window.location.reload()"><i class="fas fa-sync-alt"></i></div>
            <div class="btn-orange-round" onclick="refreshMapData()"><i class="fas fa-location-arrow"></i></div>
        </div>

        <!-- 1. SCANNING -->
        <div id="page-scanning">
            <div id="scanning-screen">
                <div class="radar-box">
                    <div class="pulse-ring"></div>
                    <div class="pulse-ring"></div>
                    <div class="center-logo"><img src="https://cdn-icons-png.flaticon.com/512/7541/7541900.png" style="width:100%"></div>
                </div>
                <h2>Finding Orders...</h2>
                <p style="opacity:0.7">Wait here for new requests</p>
            </div>
        </div>

        <!-- 2. DELIVERY & SHEET -->
        <div id="page-delivery" class="hidden">
            <div id="map-view"></div>
            
            <div class="bottom-sheet" id="bottom-sheet">
                <!-- DRAG HANDLE AREA -->
                <div class="sheet-drag-area" id="sheet-header">
                    <div class="sheet-handle"></div>
                    <div class="sheet-minimized-info">
                        <span style="color:var(--primary)">ORDER</span>
                        <span id="mini-order-id">#LOADING</span>
                    </div>
                </div>

                <!-- CONTENT (Hidden when collapsed) -->
                <div class="sheet-content">
                    <!-- Customer -->
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
                        <div style="display:flex; align-items:center; gap:15px">
                            <img src="" id="cust-img" style="width:60px; height:60px; border-radius:15px; object-fit:cover; background:#eee" onclick="openImgPopup(this.src)">
                            <div>
                                <h3 id="cust-name">Customer</h3>
                                <div style="color:var(--success); font-weight:700">Earnings: ৳<span id="stat-earn">0</span></div>
                            </div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-size:0.8rem; color:#888">Distance</div>
                            <div style="font-weight:700; font-size:1.2rem; color:var(--primary)" id="stat-dist">0 km</div>
                        </div>
                    </div>

                    <!-- Premium Location Card -->
                    <div class="loc-card">
                        <i class="fas fa-map-marker-alt loc-icon"></i>
                        <div>
                            <div style="font-size:0.75rem; color:#BF360C; font-weight:700; text-transform:uppercase">Delivery Location</div>
                            <div style="font-size:1rem; font-weight:600; line-height:1.2" id="cust-addr">Loading...</div>
                        </div>
                    </div>

                    <!-- Items -->
                    <div style="margin-bottom:15px; font-weight:700; color:#888">ITEMS</div>
                    <div id="item-list"></div>

                    <!-- Actions -->
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:20px">
                        <button class="btn-orange-round" style="width:100%; border-radius:15px; font-weight:600; gap:10px" onclick="openMap()">
                            <i class="fas fa-directions"></i> Navigate
                        </button>
                        <div style="text-align:center; font-weight:700; font-size:1.2rem; align-self:center">
                            Collect: <span style="color:var(--primary)" id="bill-grand">৳0</span>
                        </div>
                    </div>

                    <button class="btn-call-premium" onclick="callCustomer()">
                        <i class="fas fa-phone-alt"></i> CALL CUSTOMER
                    </button>

                    <!-- Slider -->
                    <div class="slider-wrapper" id="slider-btn">
                        <div class="slider-thumb" id="slider-thumb"><i class="fas fa-chevron-right"></i></div>
                        <div class="slider-text" id="slider-text">SWIPE TO PICKUP</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ALERT MODAL -->
    <div id="incoming-modal" class="incoming-modal hidden">
        <div class="incoming-card">
            <div style="width:70px; height:70px; background:rgba(255,87,34,0.1); border-radius:50%; margin:0 auto 15px; display:flex; align-items:center; justify-content:center; color:var(--primary); font-size:2rem;">
                <i class="fas fa-bell fa-shake"></i>
            </div>
            <h2>New Order!</h2>
            <p id="alert-addr" style="color:#666; margin-bottom:10px">Address...</p>
            <h3 style="color:var(--success); margin-bottom:25px" id="alert-earn">৳ 0</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px">
                <button class="btn-main" style="background:#FF9800" onclick="holdOrder()">HOLD</button>
                <button class="btn-main" onclick="acceptOrder(false)">ACCEPT</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, update, get, child, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC-QeK211wkCYaO8hjJS89P0lldCTHMp38", authDomain: "topup-52074.firebaseapp.com",
            databaseURL: "https://topup-52074-default-rtdb.firebaseio.com", projectId: "topup-52074", storageBucket: "topup-52074.appspot.com",
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // VARS
        let riderData = null, currentOrder = null, incomingRef = null, heldOrders = {};
        let map, rMarker, cMarker, routeLine;
        let isSheetOpen = false;
        let riderLoc = { lat: 23.8103, lng: 90.4125 };

        // UTILS
        window.showToast = (msg) => {
            const d = document.createElement('div'); 
            d.style.cssText = "position:fixed;top:80px;left:50%;transform:translateX(-50%);background:#222;color:white;padding:10px 20px;border-radius:30px;z-index:9999;font-weight:600";
            d.innerText = msg; document.body.appendChild(d); setTimeout(()=>d.remove(),3000);
        }
        const toggleLoader = s => document.getElementById('loader').classList.toggle('hidden',!s);
        window.openImgPopup = (src) => { document.getElementById('popup-img-src').src = src; document.getElementById('img-popup').classList.add('active'); }
        window.closeImgPopup = () => { document.getElementById('img-popup').classList.remove('active'); }

        // --- AUTH ---
        window.onload = () => {
            setTimeout(() => {
                document.getElementById('splash-screen').style.opacity = '0';
                setTimeout(() => document.getElementById('splash-screen').classList.add('hidden'), 500);
            }, 2500);

            if(localStorage.getItem('saved_lic')) document.getElementById('license-input').value = localStorage.getItem('saved_lic');
            const sess = localStorage.getItem('money_rider_sess');
            if(sess) { riderData = JSON.parse(sess); startApp(); }
            else document.getElementById('login-screen').classList.remove('hidden');
        };

        window.verifyLicense = async () => {
            const key = document.getElementById('license-input').value.trim();
            if(!key) return showToast("Enter License");
            toggleLoader(true);
            const s = await get(ref(db, 'riders'));
            let valid = false;
            s.forEach(c => { if(c.val().license === key) { valid = true; riderData = { key: c.key, ...c.val() }; } });
            toggleLoader(false);
            if(valid) {
                if(document.getElementById('remember-me').checked) localStorage.setItem('saved_lic', key);
                localStorage.setItem('money_rider_sess', JSON.stringify(riderData));
                startApp();
            } else showToast("Invalid License");
        };

        window.logout = () => { localStorage.removeItem('money_rider_sess'); location.reload(); };

        // --- MAIN ---
        function startApp() {
            document.querySelectorAll('.auth-screen').forEach(e => e.classList.add('hidden'));
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('side-name').innerText = riderData.name;
            
            if(navigator.geolocation) {
                navigator.geolocation.watchPosition(p => {
                    riderLoc = { lat: p.coords.latitude, lng: p.coords.longitude };
                    update(ref(db, `riders/${riderData.key}`), { lat: riderLoc.lat, lng: riderLoc.lng, lastSeen: Date.now() });
                    if(map) updateMap();
                }, null, { enableHighAccuracy: true });
            }
            listenOrders();
            recoverOrder();
        }

        // --- SHEET GESTURES ---
        const sheet = document.getElementById('bottom-sheet');
        const header = document.getElementById('sheet-header');
        let startY = 0;

        header.addEventListener('touchstart', (e) => { startY = e.touches[0].clientY; });
        header.addEventListener('touchmove', (e) => {
            const currentY = e.touches[0].clientY;
            const diff = currentY - startY;
            if(diff < -50) openSheet(); // Swipe Up
            if(diff > 50) closeSheet(); // Swipe Down
        });
        header.addEventListener('click', () => { if(isSheetOpen) closeSheet(); else openSheet(); });

        function openSheet() { sheet.classList.add('open'); isSheetOpen = true; }
        function closeSheet() { sheet.classList.remove('open'); isSheetOpen = false; }

        // --- LOGIC ---
        function listenOrders() {
            onValue(ref(db, 'orders'), snap => {
                let found = false;
                if(snap.exists()) {
                    snap.forEach(user => {
                        user.forEach(order => {
                            const o = order.val();
                            if(o.status === 'pending' && !heldOrders[order.key]) {
                                incomingRef = { uid: user.key, oid: order.key, data: o };
                                document.getElementById('incoming-modal').classList.remove('hidden');
                                document.getElementById('alert-addr').innerText = o.address.area;
                                document.getElementById('alert-earn').innerText = "৳" + o.totals.deliveryCharge;
                                found = true;
                            }
                        });
                    });
                }
                if(!found) document.getElementById('incoming-modal').classList.add('hidden');
            });
        }

        window.holdOrder = () => {
            if(!incomingRef) return;
            heldOrders[incomingRef.oid] = incomingRef;
            document.getElementById('incoming-modal').classList.add('hidden');
            renderHold();
            incomingRef = null;
        };
        
        function renderHold() {
            const l = document.getElementById('hold-list-container'); l.innerHTML = "";
            Object.keys(heldOrders).forEach(k => {
                const i = heldOrders[k];
                l.innerHTML += `<div style="background:#fff3e0; padding:10px; margin-bottom:5px; border-radius:10px; border:1px solid orange">
                    <b>#${i.oid.slice(-4)}</b> <br> ${i.data.address.area}
                    <div style="display:flex; gap:10px; margin-top:5px">
                        <button onclick="acceptHold('${k}')" style="background:green; color:white; border:none; padding:5px 10px; border-radius:5px">Accept</button>
                        <button onclick="delete heldOrders['${k}']; renderHold()" style="background:red; color:white; border:none; padding:5px 10px; border-radius:5px">Del</button>
                    </div>
                </div>`;
            });
        }

        window.acceptHold = (k) => { incomingRef = heldOrders[k]; acceptOrder(true); };

        window.acceptOrder = async (hold) => {
            if(!incomingRef) return;
            if(currentOrder) return showToast("Finish current order first");
            toggleLoader(true);
            
            const path = `orders/${incomingRef.uid}/${incomingRef.oid}`;
            const s = await get(child(ref(db), `${path}/status`));
            
            if(s.val() === 'pending') {
                await update(ref(db, path), { status: 'accepted', riderId: riderData.key, riderName: riderData.name, riderPhone: riderData.phone||"N/A" });
                currentOrder = { id: incomingRef.oid, uid: incomingRef.uid, ...incomingRef.data, status: 'accepted' };
                document.getElementById('incoming-modal').classList.add('hidden');
                if(hold) { delete heldOrders[incomingRef.oid]; renderHold(); }
                initDelivery();
            } else {
                showToast("Already Taken");
                document.getElementById('incoming-modal').classList.add('hidden');
            }
            toggleLoader(false);
        };

        function recoverOrder() {
            onValue(ref(db, 'orders'), snap => {
                let act = false;
                if(snap.exists()) {
                    snap.forEach(user => {
                        user.forEach(order => {
                            const o = order.val();
                            if(o.riderId === riderData.key && (o.status === 'accepted' || o.status === 'ontheway')) {
                                currentOrder = { id: order.key, uid: user.key, ...o };
                                act = true;
                            }
                        });
                    });
                }
                if(act) { document.getElementById('incoming-modal').classList.add('hidden'); initDelivery(); }
                else { document.getElementById('page-scanning').classList.remove('hidden'); document.getElementById('page-delivery').classList.add('hidden'); }
            }, {onlyOnce:true});
        }

        // --- MAP & DELIVERY ---
        function initDelivery() {
            document.getElementById('page-scanning').classList.add('hidden');
            document.getElementById('page-delivery').classList.remove('hidden');
            
            if(!map) { map = L.map('map-view', {zoomControl:false}).setView([riderLoc.lat, riderLoc.lng], 14); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); }
            setTimeout(() => { map.invalidateSize(); updateMap(); }, 500);

            onValue(ref(db, `orders/${currentOrder.uid}/${currentOrder.id}/location`), s => { if(s.exists()) { currentOrder.location = s.val(); updateMap(); } });

            // Fill UI
            document.getElementById('mini-order-id').innerText = "#" + currentOrder.id.slice(-5).toUpperCase();
            
            get(ref(db, `users/${currentOrder.uid}/profile`)).then(s => {
                const p = s.val() || {};
                document.getElementById('cust-name').innerText = p.displayName || "Customer";
                document.getElementById('cust-img').src = p.avatarUrl || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
                currentOrder.custPhone = p.phone || currentOrder.address.contactNumber;
            });
            
            const addr = currentOrder.address.area === 'DOHS' ? `DOHS Rd ${currentOrder.address.road}, House ${currentOrder.address.house}` : currentOrder.address.details;
            document.getElementById('cust-addr').innerText = addr;
            document.getElementById('stat-earn').innerText = currentOrder.totals.deliveryCharge;
            document.getElementById('bill-grand').innerText = currentOrder.payment.method==='cod'? "৳ "+currentOrder.totals.grandTotal : "PAID";
            
            document.getElementById('item-list').innerHTML = currentOrder.items.map(i => `<div class="item-row"><img src="${i.image}" style="width:40px;height:40px;border-radius:5px"><div>${i.name} <b style="color:var(--primary)">x${i.qty}</b></div></div>`).join('');
            
            resetSlider(currentOrder.status === 'ontheway');
            // Do NOT open sheet automatically, keep it peeked
            closeSheet();
        }

        function updateMap() {
            if(!map) return;
            const rIcon = L.divIcon({className:'x', html:`<div style='width:40px;height:40px;background:#FF5722;border:3px solid white;border-radius:50%;display:flex;justify-content:center;align-items:center;color:white;box-shadow:0 5px 15px rgba(0,0,0,0.3)'><i class='fas fa-motorcycle'></i></div>`});
            const cIcon = L.divIcon({className:'x', html:`<div style='width:40px;height:40px;background:#333;border:3px solid white;border-radius:50%;display:flex;justify-content:center;align-items:center;color:white;box-shadow:0 5px 15px rgba(0,0,0,0.3)'><i class='fas fa-map-marker-alt'></i></div>`});

            if(rMarker) rMarker.setLatLng([riderLoc.lat, riderLoc.lng]); else rMarker = L.marker([riderLoc.lat, riderLoc.lng], {icon: rIcon}).addTo(map);
            
            if(currentOrder.location && currentOrder.location.enabled) {
                const cLoc = [currentOrder.location.lat, currentOrder.location.lng];
                if(cMarker) cMarker.setLatLng(cLoc); else cMarker = L.marker(cLoc, {icon: cIcon}).addTo(map);
                if(routeLine) map.removeLayer(routeLine);
                routeLine = L.polyline([[riderLoc.lat, riderLoc.lng], cLoc], {color:'#FF5722', weight:5}).addTo(map);
                try{map.fitBounds(L.featureGroup([rMarker, cMarker]).getBounds(),{padding:[50,50]})}catch(e){}
                
                // Dist
                const R=6371, dLat=(cLoc[0]-riderLoc.lat)*Math.PI/180, dLon=(cLoc[1]-riderLoc.lng)*Math.PI/180;
                const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(riderLoc.lat*Math.PI/180)*Math.cos(cLoc[0]*Math.PI/180) * Math.sin(dLon/2)*Math.sin(dLon/2);
                document.getElementById('stat-dist').innerText = (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))).toFixed(1) + " km";
            }
        }

        // --- SLIDER ---
        function resetSlider(drop) {
            const t = document.getElementById('slider-thumb'), x = document.getElementById('slider-text');
            t.style.transform = 'translateX(0)';
            if(drop) { x.innerText = "SWIPE TO COMPLETE"; t.style.background = "#00C853"; } 
            else { x.innerText = "SWIPE TO PICKUP"; t.style.background = "#FF5722"; }
            
            let startX, max;
            const start=e=>{ startX = e.touches?e.touches[0].clientX:e.clientX; max=document.getElementById('slider-btn').offsetWidth-60; document.addEventListener('touchmove',move); document.addEventListener('touchend',end); };
            const move=e=>{ let dx=(e.touches?e.touches[0].clientX:e.clientX)-startX; if(dx<0)dx=0; if(dx>max)dx=max; t.style.transform=`translateX(${dx}px)`; };
            const end=async()=>{ 
                let cur = parseFloat(t.style.transform.replace(/[^\d.]/g,''))||0;
                if(cur>max-20) { 
                    t.style.transform=`translateX(${max}px)`; 
                    if(drop) { await update(ref(db, `orders/${currentOrder.uid}/${currentOrder.id}`), {status:'delivered', completedAt:Date.now()}); showToast("Delivered!"); currentOrder=null; if(map){map.removeLayer(cMarker);map.removeLayer(routeLine);cMarker=null;} document.getElementById('page-scanning').classList.remove('hidden'); document.getElementById('page-delivery').classList.add('hidden'); }
                    else { await update(ref(db, `orders/${currentOrder.uid}/${currentOrder.id}`), {status:'ontheway'}); showToast("Picked Up!"); resetSlider(true); }
                } else t.style.transform='translateX(0)';
                document.removeEventListener('touchmove',move); document.removeEventListener('touchend',end); 
            };
            t.addEventListener('touchstart', start); t.addEventListener('mousedown', start);
        }

        // ACTIONS
        window.toggleSidebar = () => { document.querySelector('.sidebar').classList.toggle('open'); document.querySelector('.sidebar-overlay').classList.toggle('open'); };
        window.refreshMapData = () => { if(map) { map.invalidateSize(); updateMap(); showToast("Refreshed"); } };
        window.callCustomer = () => { if(currentOrder.custPhone) window.open(`tel:${currentOrder.custPhone}`); else showToast("No Phone"); };
        window.openMap = () => { if(currentOrder.location) window.open(`https://www.google.com/maps/dir/?api=1&destination=${currentOrder.location.lat},${currentOrder.location.lng}`); else showToast("No Loc"); };
    </script>
</body>
</html>
